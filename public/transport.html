<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Public Transport Route Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* ✅ Remove scrollbar */
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    header {
      padding: 1rem 2rem;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    nav a {
      text-decoration: none;
      color: #005b96;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .main-container {
      display: flex;
      height: calc(100% - 80px);
    }
    #map {
      flex: 2;
      height: 100%;
    }
    #sidebar {
      flex: 1;
      max-width: 400px;
      padding: 1rem;
      background-color: #f5f5f5;
      overflow-y: auto;
      overflow-x: hidden;
      border-left: 1px solid #ddd;
    }
    h2 {
      margin-top: 1rem;
    }
    button {
      padding: 0.6rem 1rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      cursor: pointer;
      background-color: #005b96;
      color: white;
      border: none;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    button:hover {
      background-color: #004080;
    }
    #savedRoutesList button {
      margin-top: 0.4rem;
    }
    #routeNameInput {
      padding: 0.5rem;
      width: 100%;
      font-size: 1rem;
      margin: 0.5rem 0;
    }
    li {
      margin-bottom: 0.8rem;
      list-style: none;
    }
    .load-btn {
      background-color: #0074d9;
    }
    .delete-btn {
      background-color: #d00000;
    }
    .load-btn:hover {
      background-color: #005bb5;
    }
    .delete-btn:hover {
      background-color: #a60000;
    }
    .route-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
  </style>
</head>
<body>

  <header>
    <img src="background/LB logo.png" alt="Lions Befrienders Logo" style="height: 50px;">
    <nav><a href="home1.html">Home</a></nav>
  </header>

  <div class="main-container">
    <div id="map"></div>
    <div id="sidebar">
      <h2>Route Steps</h2>
      <div id="route-instructions"><strong>Click on map to select start and end points.</strong></div>
      <button id="confirmStartBtn" disabled>✅ Confirm Start</button>
      <button id="confirmEndBtn" disabled>✅ Confirm End</button>
      <button id="resetBtn">🔄 Reset Route</button>
      <hr />
      <h2>Saved Routes</h2>
      <input id="routeNameInput" type="text" placeholder="Name this route (e.g. Work)" />
      <button id="saveRouteBtn" disabled>💾 Save This Route</button>
      <ul id="savedRoutesList"></ul>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const token = localStorage.getItem("jwtToken");
    if (!token) {
      alert("Please login first.");
      window.location.href = "auth.html";
    }

    const authHeaders = {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    };

    const map = L.map("map").setView([1.3521, 103.8198], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let startMarker, endMarker, routeLine;
    let confirmedStart = null, confirmedEnd = null, selecting = "start";
    let latestRoute = null;

    const confirmStartBtn = document.getElementById("confirmStartBtn");
    const confirmEndBtn = document.getElementById("confirmEndBtn");
    const resetBtn = document.getElementById("resetBtn");
    const instructionsDiv = document.getElementById("route-instructions");
    const saveBtn = document.getElementById("saveRouteBtn");
    const nameInput = document.getElementById("routeNameInput");
    const savedRoutesList = document.getElementById("savedRoutesList");

    map.on("click", (e) => {
      const latlng = e.latlng;
      if (selecting === "start") {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker(latlng).addTo(map).bindPopup("<b>📍 Start</b>").openPopup();
        confirmStartBtn.disabled = false;
      } else {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker(latlng).addTo(map).bindPopup("<b>🏁 End</b>").openPopup();
        confirmEndBtn.disabled = false;
      }
    });

    confirmStartBtn.addEventListener("click", () => {
      confirmedStart = startMarker.getLatLng();
      confirmStartBtn.disabled = true;
      selecting = "end";
      alert("✅ Start confirmed! Now click the end point.");
    });

    confirmEndBtn.addEventListener("click", () => {
      confirmedEnd = endMarker.getLatLng();
      confirmEndBtn.disabled = true;
      getRoute();
    });

    resetBtn.addEventListener("click", () => {
      if (startMarker) map.removeLayer(startMarker);
      if (endMarker) map.removeLayer(endMarker);
      if (routeLine) map.removeLayer(routeLine);
      startMarker = endMarker = routeLine = confirmedStart = confirmedEnd = null;
      selecting = "start";
      confirmStartBtn.disabled = true;
      confirmEndBtn.disabled = true;
      instructionsDiv.innerHTML = "<strong>Click on map to select start and end points.</strong>";
      saveBtn.disabled = true;
      latestRoute = null;
    });

    async function getRoute() {
      const url = `http://localhost:3000/api/transport/route?startLat=${confirmedStart.lat}&startLng=${confirmedStart.lng}&endLat=${confirmedEnd.lat}&endLng=${confirmedEnd.lng}`;
      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.plan?.itineraries?.length) {
          const legs = data.plan.itineraries[0].legs;
          const routeCoords = [];

          instructionsDiv.innerHTML = `<p><strong>Duration:</strong> ~${Math.round(legs.reduce((s, l) => s + l.duration, 0) / 60)} minutes</p><ul>`;
          legs.forEach((leg) => {
            const from = leg.from.name || "Start";
            const to = leg.to.name || "End";
            const dist = (leg.distance / 1000).toFixed(2);
            const mode = leg.mode;
            const emoji = mode === "WALK" ? "🚶" : mode === "BUS" ? "🚌" : mode === "SUBWAY" ? "🚇" : "➡️";
            instructionsDiv.innerHTML += `<li><strong>${emoji} ${mode}</strong>: ${from} → ${to} (${dist} km)</li>`;
            if (leg.legGeometry?.points) {
              routeCoords.push(...decodePolyline(leg.legGeometry.points));
            }
          });
          instructionsDiv.innerHTML += "</ul>";

          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.polyline(routeCoords, { color: "#0077cc", weight: 5 }).addTo(map);
          map.fitBounds(routeLine.getBounds());

          latestRoute = { start: confirmedStart, end: confirmedEnd };
          saveBtn.disabled = false;
        } else {
          instructionsDiv.innerHTML = "<strong>No route found.</strong>";
        }
      } catch (err) {
        console.error("❌ Error fetching route:", err.message);
        instructionsDiv.innerHTML = `<p style='color:red;'>Error: ${err.message}</p>`;
      }
    }

    function decodePolyline(str) {
      let index = 0, lat = 0, lng = 0, coordinates = [];
      while (index < str.length) {
        let b, shift = 0, result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const deltaLat = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lat += deltaLat;
        shift = result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const deltaLng = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lng += deltaLng;
        coordinates.push([lat / 1e5, lng / 1e5]);
      }
      return coordinates;
    }

    function renderSavedRoutes() {
      savedRoutesList.innerHTML = "";
      const routes = JSON.parse(localStorage.getItem("savedRoutes") || "{}")[token] || [];
      routes.forEach((route, i) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${route.name}</strong>
          <div class="route-buttons">
            <button class="load-btn" onclick="loadSavedRoute(${i})">🧭 Load</button>
            <button class="delete-btn" onclick="deleteSavedRoute(${i})">🗑️ Delete</button>
          </div>
        `;
        savedRoutesList.appendChild(li);
      });
    }

    window.loadSavedRoute = (index) => {
      const routes = JSON.parse(localStorage.getItem("savedRoutes") || "{}")[token] || [];
      const route = routes[index];
      if (!route) return;
      resetBtn.click();
      confirmedStart = route.start;
      confirmedEnd = route.end;
      startMarker = L.marker(confirmedStart).addTo(map).bindPopup("<b>📍 Start</b>").openPopup();
      endMarker = L.marker(confirmedEnd).addTo(map).bindPopup("<b>🏁 End</b>").openPopup();
      getRoute();
    };

    window.deleteSavedRoute = (index) => {
      const routes = JSON.parse(localStorage.getItem("savedRoutes") || "{}");
      if (!routes[token]) return;
      routes[token].splice(index, 1);
      localStorage.setItem("savedRoutes", JSON.stringify(routes));
      renderSavedRoutes();
    };

    saveBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      if (!name || !latestRoute) return alert("Enter name and confirm route first.");
      try {
        await fetch("http://localhost:3000/api/transport/saveRoute", {
          method: "POST",
          headers: authHeaders,
          body: JSON.stringify({ route: { name, ...latestRoute } }),
        });
        alert("✅ Route saved to server.");
      } catch (err) {
        console.error("❌ Failed to save:", err);
      }

      const routes = JSON.parse(localStorage.getItem("savedRoutes") || "{}");
      if (!routes[token]) routes[token] = [];
      routes[token].push({ name, ...latestRoute });
      localStorage.setItem("savedRoutes", JSON.stringify(routes));
      nameInput.value = "";
      saveBtn.disabled = true;
      renderSavedRoutes();
    });

    document.addEventListener("DOMContentLoaded", renderSavedRoutes);
  </script>
</body>
</html>
