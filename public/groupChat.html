<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="groupChat.css" />
  <title>Group Chat</title>
    
</head>

<body>

      <!-- Navbar -->
  <nav class="nav-bar">
    <div class="nav-container">
      <div class="nav-logo">LOGO</div>
      <ul class="nav-links">
        <li><a href="#">Home</a></li>
        <li><a href="#">Events</a></li>
        <li><a href="#">Hobbies</a></li>
        <li><a href="#">Chat</a></li>
        <li><a href="#">FAQ</a></li>
      </ul>
      <button class="nav-login">Login</button>
    </div>
  </nav>


  <h2 id="chat-title">Loading...</h2>


  <p id="user-label"></p>


  <div id="chat-box"></div>

  <form id="chat-input">
    <input type="text" id="message" placeholder="Type your message..." required />
    <button type="submit" id="send-btn">Send</button>
  </form>

  <script>
  const urlParams = new URLSearchParams(window.location.search);
  const hobbyId = urlParams.get("hobbyId");

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName");

  if (!userId) {
    alert("Please log in first.");
    window.location.href = "home.html";
  } else {
    document.getElementById("user-label").textContent = `Logged in as: ${userName}`;
  }

  async function loadHobbyName() {
    try {
      const res = await fetch(`/api/hobbies/${hobbyId}`);
      const hobby = await res.json();
      document.getElementById("chat-title").textContent = hobby.name;
    } catch (err) {
      document.getElementById("chat-title").textContent = "Group Chat";
      console.error("Failed to load hobby name:", err);
    }
  }

  const chatBox = document.getElementById("chat-box");
  const form = document.getElementById("chat-input");

  async function fetchMessages() {
    const res = await fetch(`/api/groupchat/${hobbyId}`);
    const messages = await res.json();

    chatBox.innerHTML = "";

    messages.reverse().forEach(msg => {
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `
        <span class="sender">${msg.sender_name}</span>
        <span class="timestamp">(${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })})</span>
        <div>${msg.content}</div>
      `;
      chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const content = document.getElementById("message").value;

    const res = await fetch(`/api/groupchat/${hobbyId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "userId": userId
      },
      body: JSON.stringify({ content })
    });

    if (res.ok) {
      document.getElementById("message").value = "";
      await fetchMessages();
    } else {
      const data = await res.json();
      alert(data.message || "Error sending message");
    }
  });

  window.onload = () => {
    loadHobbyName();
    fetchMessages();
    setInterval(fetchMessages, 5000);
  };
</script>

</body>
</html>
